pipeline {
  agent any

  environment {
    DASHBOARD_ADMIN_KEY = credentials('tyk-dashboard-admin-key')
    DASHBOARD_URL = 'http://tyk-dashboard:3000'
  }

  options { timestamps() }

  stages {

    stage('Delete API from Dashboard') {
        steps {
            sh '''
            curl -s -X DELETE \
                -H "authorization: $TYK_AUTH" \
                http://tyk-dashboard:3000/api/apis/dummy-api-v1
            '''
        }
    }

    stage('Reload Gateway') {
        steps {
            sh '''
            curl -s -X POST \
                -H "authorization: $TYK_AUTH" \
                http://tyk-dashboard:3000/api/reload
            '''
        }
    }

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Create or Update API in Dashboard') {
      steps {
        sh '''
          echo "Creating API in Tyk Dashboard..."

          curl -s -X POST \
            -H "authorization: ${DASHBOARD_ADMIN_KEY}" \
            -H "Content-Type: application/json" \
            ${DASHBOARD_URL}/api/apis \
            -d @tyk/apis/dummy-api.json
        '''
      }
    }

  }
}